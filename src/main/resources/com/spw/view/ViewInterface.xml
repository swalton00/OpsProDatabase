<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spw.view.ViewInterface">
    <select id="listViewCars">
        SELECT
            cars.id,
            carid,
            ct.CAR_TYPE as carType,
            roadname,
            roadnumber,
            carload
        FROM
            cars
        LEFT OUTER JOIN CAR_TYPE as ct
        ON cars.CAR_TYPE = ct.ID
        WHERE
            runid = #{runId}
    </select>
    <select id="listViewLocs" resultMap="locResult">
        SELECT
            l.id as id,
            xmlid,
            l.name as name,
            t.id AS trkId,
            t.trkid as thisId,
            t.trkname as trkname
        FROM
            locations l
        LEFT OUTER JOIN
            tracks t
        ON
            t.parentid = l.id
        WHERE
            l.runid = #{runId}
            AND t.runid = #{runId}
        ORDER BY
            name
    </select>
    <resultMap id="locResult" type="com.spw.view.ViewLoc">
        <id property="id" column="id"/>
        <result property="xmlId" column="xmlId"/>
        <result property="name" column="name"/>
        <collection property="tracks" ofType="com.spw.view.ViewTrack">
            <id property="id" column="trkId"/>
            <result property="trkId" column="thisId"/>
            <result property="trackName" column="trkname"/>
        </collection>
    </resultMap>
    <select id="getSequenceNumbers">
        SELECT
            DISTINCT seq_num
        FROM
            run_locs
        WHERE
            runId = #{runId}
        ORDER BY
            seq_num ASC
    </select>
    <resultMap id="rowResults" type="RowElement">
        <id property="id" column="id"/>
        <result property="carId" column="carId"/>
        <result property="carType" column="carType"/>
        <result property="roadName" column="roadName"/>
        <result property="roadNumber" column="roadNumber"/>
        <collection property="elements" ofType="ViewElement">
            <id column="rowId" property="id"/>
            <result column="seq" property="sequenceNumber"/>
            <result property="trkId" column="trkId"/>
            <result property="load" column="load"/>
            <result property="trackName" column="trackName"/>
            <result property="location" column="location"/>
        </collection>
    </resultMap>
    <select id="listRows" resultMap="rowResults">
        SELECT
            c.id as id,
            c.carid as carId,
            roadname,
            roadnumber,
            ct.CAR_TYPE as carType,
            r.id as rowId,
            r.seq_num as Seq,
            r.trkid as trkId,
            r.load as load,
            t.trkname as trackName,
            l.name as location
        FROM
            cars c
        INNER JOIN
            run_locs AS r
        ON
            c.carid = r.carid
        INNER JOIN
            tracks t
        ON
            t.trkid = r.trkid
        INNER JOIN
            locations l
        ON
            t.parentId = l.id
        LEFT OUTER JOIN CAR_TYPE ct
        ON c.CAR_TYPE = ct.ID
        WHERE
            c.runid = #{runId}
            AND t.runId = c.runId
            AND l.runId = c.runId
            AND r.runId = c.runId
        <if test="carSelect.name() == 'MOVED'">
            <include refid="carsMoved"/>
        </if>
        <if test="carSelect.name() == 'SPECIFIC'">
            AND
            <foreach collection="idList" item="item" separator=", " open="c.carid in ( " close=" )">
                #{item}
            </foreach>
        </if>
        ORDER BY
            roadname,
            roadnumber
    </select>
    <select id="listLocRows" resultMap="locResMap">
        SELECT
            t.trkId,
            t.id as idNumber,
            t.trkName,
            l.name    AS locName,
            r.seq_Num AS sequence,
            r.load as load,
            r.carid   AS carid
        FROM
            tracks AS T
        INNER JOIN
            locations AS l
        ON
            t.parentid = l.id
        and t.runid = l.runid
        LEFT OUTER JOIN
            run_locs AS r
        ON
            r.trkid = t.trkid
        and (r.runid = t.runid or
        r.runid is null)
        LEFT OUTER JOIN
            cars c
        ON
            c.carid = r.carid
        and c.runid = t.runid
        WHERE
            t.runid = #{runId}
            AND l.runid = t.runid
            AND (r.runid = t.runid
                OR r.runid is null)
        <if test="locSelect.name() == 'WITH'">
            AND r.runid is NOT NULL
        </if>
        <if test="locSelect.name() == 'MOVED'">
            <include refid="carsMoved"/>
        </if>
        <if test="locSelect.name() == 'SPECIFIC'">
            AND
            <foreach collection="idList" item="item" separator=", " open="t.trkid in ( " close=" )">
                #{item}
            </foreach>
        </if>
        ORDER BY locname, trkname
    </select>
    <resultMap id="locResMap" type="RowElement">
        <id column="idNumber" property="id"/>
        <result property="trackName" column="trkName"/>
        <result column="locName" property="location"/>
        <result column="trkId" property="trkId"/>
        <collection property="elements" ofType="ViewElement">
            <id property="sequenceNumber" column="sequence"/>
            <collection property="carList" ofType="InnerCar">
                <id column="carid" property="carId"/>
                <result column="load" property="load"/>
            </collection>
        </collection>
    </resultMap>
    <sql id="carsMoved">
        AND EXISTS
        (   SELECT
            *
        FROM
            run_locs r1
        INNER JOIN
            run_locs r2
        ON
            r1.runid = r2.runid
            AND r1.carid = r2.carid
            AND r.carid = r1.carid
            AND NOT ( r1.trkid = r2.trkid ))
    </sql>
</mapper>