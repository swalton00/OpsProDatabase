<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spw.view.ViewInterface">
    <select id="listViewCars">
        SELECT
            id,
            carid,
            roadname,
            roadnumber,
            carload
        FROM
            cars
        WHERE
            runid = #{runId}
    </select>
    <select id="listViewLocs" resultMap="locResult">
        SELECT
            l.id as id,
            xmlid,
            l.name as name,
            t.id AS trkId,
            t.trkname as trkname
        FROM
            locations l
        LEFT OUTER JOIN
            tracks t
        ON
            t.parentid = l.id
        WHERE
            l.runid = #{runId}
            AND t.runid = #{runId}
        ORDER BY
            name
    </select>
    <resultMap id="locResult" type="com.spw.view.ViewLoc">
        <id property="id" column="id"/>
        <result property="xmlId" column="xmlId"/>
        <result property="name" column="name"/>
        <collection property="tracks" ofType="com.spw.view.ViewTrack">
            <id property="id" column="trkId"/>
            <result property="trackName" column="trkname"/>
        </collection>
    </resultMap>
    <select id="getSequenceNumbers">
        SELECT
            DISTINCT seq_num
        FROM
            run_locs
        WHERE
            runId = #{runId}
        ORDER BY
            seq_num ASC
    </select>
    <resultMap id="rowResults" type="RowElement">
        <id property="id" column="id"/>
        <result property="roadName" column="roadName"/>
        <result property="roadNumber" column="roadNumber"/>
        <collection property="elements" ofType="ViewElement">
            <id column="rowId" property="id"/>
            <result column="seq" property="sequenceNumber"/>
            <result property="trkId" column="trkId"/>
            <result property="load" column="load"/>
            <result property="trackName" column="trackName"/>
            <result property="location" column="location"/>
        </collection>
    </resultMap>
    <select id="listRows" resultMap="rowResults">
        SELECT
            c.id as id,
            roadname,
            roadnumber,
            r.id as rowId,
            r.seq_num as Seq,
            r.trkid as trkId,
            r.load as load,
            t.trkname as trackName,
            l.name as location
        FROM
            cars c
        INNER JOIN
            run_locs AS r
        ON
            c.carid = r.carid
        INNER JOIN
            tracks t
        ON
            t.trkid = r.trkid
        INNER JOIN
            locations l
        ON
            t.parentId = l.id
        WHERE
            c.runid = #{runId}
            AND t.runId = c.runId
            AND l.runId = c.runId
            AND r.runId = c.runId
    </select>
    <select id="listLocRows" resultMap="locResMap">
        SELECT
            t.trkId,
            t.id as idNumber,
            t.trkName,
            l.name    AS locName,
            r.seq_Num AS sequence,
            r.carid   AS carid
        FROM
            tracks AS T
        INNER JOIN
            locations AS l
        ON
            t.parentid = l.id
        LEFT OUTER JOIN
            run_locs AS r
        ON
            r.trkid = t.trkid
        WHERE
            t.runid = 'B'
            AND l.runid = t.runid
            AND (r.runid = t.runid
                OR r.runid is null)
    </select>
    <resultMap id="locResMap" type="RowElement">
        <id column="idNumber" property="id"/>
        <result property="trackName" column="trkName"/>
        <result column="locName" property="location"/>
        <result column="trkId" property="trkId"/>
        <collection property="elements" ofType="ViewElement">
            <id property="sequenceNumber" column="sequence"/>
            <collection property="carList" javaType="ArrayList">
                <id column="carid" javaType="String"/>
            </collection>
        </collection>
    </resultMap>
</mapper>